# MongoDB'de Büyük Nesne ve Dosyaların GridFS ile Yönetimi(MongoDB Öğreniyoruz 10)

GridFS MongoDB'nin 16 MB üstü dosya ve objeleri saklamak için kullandığı  araçtır. 

GridFS verilen dosyayı 256 KB'lık dosyalara bölerek saklar. GridFS için MongoDB shell kullanılmaz bunu için mongofiles cli kullanmamız gerekiyor.

Resmi sayfasında kullanım amaçlarını şu şekilde listelemiş.

- Dosya sisteminiz bir dizindeki dosya sayısını sınırlıyorsa, gerektiği kadar dosya depolamak için GridFS'yi kullanabilirsiniz.
- Tüm dosyaları belleğe yüklemek zorunda kalmadan büyük dosyaların bölümlerinden bilgilere erişmek istediğinizde, tüm dosyayı belleğe okumadan dosyaların bölümlerini geri çağırmak için GridFS'yi kullanabilirsiniz.
- Dosyalarınızı ve meta verilerinizi bir dizi sistem arasında otomatik olarak eşitlemek ve dağıtmak istediğinizde GridFS'yi kullanabilirsiniz. Coğrafi olarak dağıtılmış replica set'lari arasında da dosyaları senkronize edebilir.

Bir dosyayı atomik olarak güncellemek demek dosyayı olduğu tek seferde değiştirmek demektir. Yani klasik dosya sistemini düşünecek olursak örneğin bir text dosyasını yenisiyle değiştirmek demektir.  


Eğer tüm dosyanın içeriğini atomik olarak güncellemeniz gerekiyorsa GridFS'yi kullanmayın. Alternatif olarak, her dosyanın birden çok sürümünü depolayabilir ve dosyanın geçerli sürümünü meta verilerde belirtebilirsiniz. Dosyanın yeni sürümünü yükledikten sonra bir atom güncellemesinde "latest" durumunu gösteren meta veri alanını güncelleyebilir ve daha sonra gerekirse önceki sürümleri kaldırabilirsiniz.

Yani MongoDB dosya değiştirme yapmıyor. Onun yerine yeni verdiğiniz dosyayı aynı dosyanın yeni versiyonu olarak kaydediyor. bu son haline de zaten latest versiyon diyoruz. Daha sonra eski versiyonu sildiğimizde dosyayı bir nevi değiştirmiş oluyoruz. Buna da non-atomic update diyoruz. 


GridFS dosyaları iki collection'da tutar. 
- **chunks** : binary chunk'ları saklar. Collection adı fs.chunks
- **Files** : dosyların metadata bilgilerini tutar. Colleciton adı  fs.files

Chunks collection'ını içindeki dokümanın formu aşağıdaki gibidir.

```json
{
  "_id" : <ObjectId>,
  "files_id" : <ObjectId>,
  "n" : <num>,
  "data" : <binary>
}
```
Data alanında dosyanın binary verisi bulunmaktadır.
n alanı ise ilgili chunk'ın numarasını belirtir. MongoDb her chunk'a sıfırda başlayarak bir numara atar.

Files collection'ı içindeki dokümanın formu da aşağıdaki gibidir.

```json
{
  "_id" : <ObjectId>,
  "length" : <num>,
  "chunkSize" : <num>,
  "uploadDate" : <timestamp>,
  "md5" : <hash>,
  "filename" : <string>,
  "contentType" : <string>,
  "aliases" : <string array>,
  "metadata" : <any>,
}
```
- **length**: Dokümanın byte olarak boyutu
- **chunkSize**: Bir chunk'ın byte olarak boyutu
- **contentType**: Bu alan artık kaldırıldı. Bunu yerine metadata kullanılıyor.
- **metadata**: Kullanıcı tarafından eklenecek custom bütün alanlar bu alan kulalnılarka eklenir. Örneğin content type için _metadata.contentType_ şeklinde kullanılabilir.

Bu iki collection içinde index oluşturmak mümkün. Ancak default'da chunks files_id ve n alanını compound index olarak kullanılır. Files collection'ı ise filename ve uploadDate alanlarını compound key olarak kullanır.


örneğin bir dosyayı ararken alttaki gibi bir script kullanılabilir.

```javascript
db.fs.files.find( { filename: myFileName } ).sort( { uploadDate: 1 } )
```


# Kaynaklar
- https://www.mongodb.com/docs/manual/core/gridfs/
- https://www.knowledgehut.com/blog/web-development/what-is-mongodb-gridfs