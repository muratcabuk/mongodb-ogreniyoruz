# MongoDB'de Büyük Nesne ve Dosyaların GridFS ile Yönetimi(MongoDB Öğreniyoruz 10)

Merhaba arkadaşlar

GridFS MongoDB'nin 16 MB üstü dosya ve objeleri saklamak için kullandığı  araçtır. 

GridFS verilen dosyayı 256 KB'lık dosyalara bölerek saklar. GridFS için MongoDB shell kullanılmaz bunu için **mongofiles** cli kullanmamız gerekiyor.

Makale serisinin diğer yazıları için alttaki linkleri kullanabilirsiniz.
- [Distributed Sistemlerde Consistency Kavramı ve Document DB Karşılaştırmaları (MongoDB Öğreniyoruz 1)](1.distributed-systems.md)
- [MongoDB Kurulum ve CRUD İşlemleri (MongoDB Öğreniyoruz 2)](2.kurulum-crud-islemleri.md)
- [MongoDB'de Embedded, Referenced Document ve Relation Kavramları (MongoDB Öğreniyoruz 3)](3.embedded-ve-referenced-doküman.md)
- [MongoDB'de Detaylı Sorgulama/Querying (MongoDB Öğreniyoruz 4)](4.query-detaylari.md)
- [MongoDB'de Index Kullanımı ve Sorgu Optimizasyonu (MongoDB Öğreniyoruz 5)](5.indekslerle-calisma-optimizasyon.md)
- [MongoDB'de Aggregation Pipeline Stage Kullanımı (MongoDB Öğreniyoruz 6)](6.aggregation-stages.md)
- [MongoDB'de Aggregation Pipeline Operation Kullanımı ve Sorgu Optimizasyonu  (MongoDB Öğreniyoruz 7)](7.aggregation-operations.md)
- [MongoDB' de Transaction Yönetimi (MongoDB Öğreniyoruz 8)](8-transaction.md)
- [MongoDB' de Role Tabanlı Yetkilendirme (MongoDB Öğreniyoruz 9)](9.security.md)
- [MongoDB'de Büyük Obje ve Dosyaların GridFS ile Yönetimi(MongoDB Öğreniyoruz 10)](10.gridfs-file-management.md)

Resmi sayfasında kullanım amaçlarını şu şekilde listelemiş.

- Dosya sisteminiz bir dizindeki dosya sayısını sınırlıyorsa, gerektiği kadar dosya depolamak için GridFS'yi kullanabilirsiniz.
- Tüm dosyaları belleğe yüklemek zorunda kalmadan büyük dosyaların bölümlerinden bilgilere erişmek istediğinizde, tüm dosyayı belleğe okumadan dosyaların bölümlerini geri çağırmak için GridFS'yi kullanabilirsiniz.
- Dosyalarınızı ve meta verilerinizi bir dizi sistem arasında otomatik olarak eşitlemek ve dağıtmak istediğinizde GridFS'yi kullanabilirsiniz. Coğrafi olarak dağıtılmış replica set'lari arasında da dosyaları senkronize edebilir.

Bir dosyayı atomik olarak güncellemek demek dosyayı olduğu tek seferde değiştirmek demektir. Yani klasik dosya sistemini düşünecek olursak örneğin bir text dosyasını yenisiyle değiştirmek demektir.  


Eğer tüm dosyanın içeriğini atomik olarak güncellemeniz gerekiyorsa GridFS'yi kullanmayın. Alternatif olarak, her dosyanın birden çok sürümünü depolayabilir ve dosyanın geçerli sürümünü meta verilerde belirtebilirsiniz. Dosyanın yeni sürümünü yükledikten sonra bir atom güncellemesinde "latest" durumunu gösteren meta veri alanını güncelleyebilir ve daha sonra gerekirse önceki sürümleri kaldırabilirsiniz.

Yani MongoDB dosya değiştirme yapmıyor. Onun yerine yeni verdiğiniz dosyayı aynı dosyanın yeni versiyonu olarak kaydediyor. bu son haline de zaten latest versiyon diyoruz. Daha sonra eski versiyonu sildiğimizde dosyayı bir nevi değiştirmiş oluyoruz. Buna da non-atomic update diyoruz. 


GridFS dosyaları iki collection'da tutar. 
- **chunks** : binary chunk'ları saklar. Collection adı fs.chunks
- **Files** : dosyların metadata bilgilerini tutar. Colleciton adı  fs.files

Chunks collection'ını içindeki dokümanın formu aşağıdaki gibidir.

```json
{
  "_id" : <ObjectId>,
  "files_id" : <ObjectId>,
  "n" : <num>,
  "data" : <binary>
}
```
Data alanında dosyanın binary verisi bulunmaktadır.
n alanı ise ilgili chunk'ın numarasını belirtir. MongoDb her chunk'a sıfırda başlayarak bir numara atar.

Files collection'ı içindeki dokümanın formu da aşağıdaki gibidir.

```json
{
  "_id" : <ObjectId>,
  "length" : <num>,
  "chunkSize" : <num>,
  "uploadDate" : <timestamp>,
  "md5" : <hash>,
  "filename" : <string>,
  "contentType" : <string>,
  "aliases" : <string array>,
  "metadata" : <any>,
}
```
- **length**: Dokümanın byte olarak boyutu
- **chunkSize**: Bir chunk'ın byte olarak boyutu
- **contentType**: Bu alan artık kaldırıldı. Bunu yerine metadata kullanılıyor.
- **metadata**: Kullanıcı tarafından eklenecek custom bütün alanlar bu alan kulalnılarka eklenir. Örneğin content type için _metadata.contentType_ şeklinde kullanılabilir.

Bu iki collection içinde index oluşturmak mümkün. Ancak default'da chunks files_id ve n alanını compound index olarak kullanılır. Files collection'ı ise filename ve uploadDate alanlarını compound key olarak kullanır.


örneğin bir dosyayı ararken alttaki gibi bir script kullanılabilir.

```javascript
db.fs.files.find( { filename: myFileName } ).sort( { uploadDate: 1 } )
```

Chunks collection sharding için files_id ve n alanı kullanılır. 

Files collection için MongoDB'nin tavsiyesi bu collection için sharding kullanılmaması yönünde. Çünkü zaten boyutu çok az olacaktır primary shard'da durması yeterli olacaktır.


Evet işin teorisi bittiğine göre artık uygulamalara geçebiliriz. Ancak şunu bilmeliyiz ki mongofiles cli çok yetenekli bir araç değil biraz günü kurtarmalık administrator aracı. 


Öncelikle GridFS'İ kullanmak için kendimize bir veritabanı oluşturmamız gerekiyor.

Login olduktan sonra alttaki _use_ komutu ile oluşturmak istedğimiz veritabanı adını yazmamız yeterli. 

```javascript
mongosh "mongodb://localhost:27017/admin" -u "root" -p "password123" --authenticationDatabase "admin"    

use gridfsdb
```

İlk dosyamızı kaydettiğimizde GridFS Bucket oluşmuş olacak. 

- **Dosya kaydetmek**

```javascript
mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" put "README.md"

// sonuç

// 2022-08-08T00:25:58.148+0300    connected to: mongodb://localhost:27017
// 2022-08-08T00:25:58.148+0300    adding gridFile: README.md

// 2022-08-08T00:25:58.381+0300    added gridFile: README.md


```

Şimdi dosya listesini alalım

- **Dosya listesi almak**

```javascript
mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" list

//README.md       15896
```

- **GrşdFS'den dosya kopyalamak**

```javascript

mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" get "README.md"
```

- **Dosya silmek**

```javascript

mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" delete "README.md"

// successfully deleted all instances of 'README.md' from GridFS

```

- **Dosya bulmak**

```javascript
mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" put "README.md"

mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" search "READ"

// arama sonucu

// README.md       15896
```

- **Dosya versiyonlama ve farklı versiyonlarla çalışma**

Aynı dosyadan ardarda bir kaç kez kaydedelim.

```javascript
mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" put "README.md"

mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" put "README.md"

mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" put "README.md"

mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" search "READ"


// README.md       15896
// README.md       15896
// README.md       15896

```
Şimdi MongoDB shell ile login olup gridfsdb içindeki collection'ları listeleyelim.


```javascript

show collections

// fs.chunks
// fs.files
```

Daha sonra files'daki verileri listeleyelim.

```javascript

db.fs.files.find({})

// [
//   {
//     _id: ObjectId("62f032810ab22ea0bbe18011"),
//     length: Long("15896"),
//     chunkSize: 261120,
//     uploadDate: ISODate("2022-08-07T21:45:37.877Z"),
//     filename: 'README.md',
//     metadata: {}
//   },
//   {
//     _id: ObjectId("62f033a81621b7634adbffda"),
//     length: Long("15896"),
//     chunkSize: 261120,
//     uploadDate: ISODate("2022-08-07T21:50:32.332Z"),
//     filename: 'README.md',
//     metadata: {}
//   },
//   {
//     _id: ObjectId("62f033ab8d29cc8694543bc3"),
//     length: Long("15896"),
//     chunkSize: 261120,
//     uploadDate: ISODate("2022-08-07T21:50:35.144Z"),
//     filename: 'README.md',
//     metadata: {}
//   }
// ]

```

Örneğin üstte uplodedDate alanına bakacak olursak listedeki ilk dokümanın en eski olduğunu görebiliriz. Dosyayı silebilmek için id sütunu işimizi görecektir ancak biz birde chunks collection'ına bakalım.

```javascript

db.fs.chunks.find({ },{_id: 1,files_id: 1})

// sonuç

// [
//   {
//     _id: ObjectId("62f032810ab22ea0bbe18012"),
//     files_id: ObjectId("62f032810ab22ea0bbe18011")
//   },
//   {
//     _id: ObjectId("62f033a81621b7634adbffdb"),
//     files_id: ObjectId("62f033a81621b7634adbffda")
//   },
//   {
//     _id: ObjectId("62f033ab8d29cc8694543bc4"),
//     files_id: ObjectId("62f033ab8d29cc8694543bc3")
//   }
// ]

```
Görüleceği üzere fs.files collection'ını ile fs.chunks arasında one-to-one bir ilişki var.


Files_id'si "62f032810ab22ea0bbe18011" olanı silebiliriz. 


```javascript
mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" delete_id '{"$oid": "62f032810ab22ea0bbe18011"}'
```

Tekrar listeye bakalım.

```javascript

db.fs.chunks.find({ },{_id: 1,files_id: 1})

// [
//   {
//     _id: ObjectId("62f033a81621b7634adbffdb"),
//     files_id: ObjectId("62f033a81621b7634adbffda")
//   },
//   {
//     _id: ObjectId("62f033ab8d29cc8694543bc4"),
//     files_id: ObjectId("62f033ab8d29cc8694543bc3")
//   }
// ]

```



- **GridFS'den id'sine göre dosya getirmek**

```javascript
mongofiles "mongodb://localhost:27017" -u "root" -p "password123" -d "gridfsdb" --authenticationDatabase "admin" get_id '{"$oid": "62f033ab8d29cc8694543bc3"}'
```

Bu yazımızın da sonuna geldik  umarım faydalı olmuştur.

Makale serisinin diğer yazıları için alttaki linkleri kullanabilirsiniz.
- [Distributed Sistemlerde Consistency Kavramı ve Document DB Karşılaştırmaları (MongoDB Öğreniyoruz 1)](1.distributed-systems.md)
- [MongoDB Kurulum ve CRUD İşlemleri (MongoDB Öğreniyoruz 2)](2.kurulum-crud-islemleri.md)
- [MongoDB'de Embedded, Referenced Document ve Relation Kavramları (MongoDB Öğreniyoruz 3)](3.embedded-ve-referenced-doküman.md)
- [MongoDB'de Detaylı Sorgulama/Querying (MongoDB Öğreniyoruz 4)](4.query-detaylari.md)
- [MongoDB'de Index Kullanımı ve Sorgu Optimizasyonu (MongoDB Öğreniyoruz 5)](5.indekslerle-calisma-optimizasyon.md)
- [MongoDB'de Aggregation Pipeline Stage Kullanımı (MongoDB Öğreniyoruz 6)](6.aggregation-stages.md)
- [MongoDB'de Aggregation Pipeline Operation Kullanımı ve Sorgu Optimizasyonu  (MongoDB Öğreniyoruz 7)](7.aggregation-operations.md)
- [MongoDB' de Transaction Yönetimi (MongoDB Öğreniyoruz 8)](8-transaction.md)
- [MongoDB' de Role Tabanlı Yetkilendirme (MongoDB Öğreniyoruz 9)](9.security.md)
- [MongoDB'de Büyük Obje ve Dosyaların GridFS ile Yönetimi(MongoDB Öğreniyoruz 10)](10.gridfs-file-management.md)

# Kaynaklar
- https://www.mongodb.com/docs/manual/core/gridfs/
- https://www.knowledgehut.com/blog/web-development/what-is-mongodb-gridfs
- https://www.mongodb.com/docs/database-tools/mongofiles/#mongodb-binary-bin.mongofiles
- 